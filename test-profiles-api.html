<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile API Tests - Coach2Coach</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #333; margin-top: 0; }
    h2 { color: #666; border-bottom: 2px solid #eee; padding-bottom: 8px; }
    .test-section { margin-bottom: 30px; }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover { background: #2563eb; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .success {
      background: #10b981;
      color: white;
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
    }
    .error {
      background: #ef4444;
      color: white;
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
    }
    .info {
      background: #3b82f6;
      color: white;
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
    }
    .result {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-all;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .auth-status {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    .logged-in {
      background: #d1fae5;
      color: #065f46;
    }
    .logged-out {
      background: #fee2e2;
      color: #991b1b;
    }
    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Profile API Testing Suite</h1>
    <div id="authStatus" class="auth-status logged-out">Not authenticated</div>
  </div>

  <!-- Authentication Section -->
  <div class="container">
    <h2>1. Authentication</h2>
    <div class="test-section">
      <h3>Sign Up</h3>
      <input type="email" id="signupEmail" placeholder="Email" value="test@example.com">
      <input type="password" id="signupPassword" placeholder="Password" value="password123">
      <button onclick="testSignup()">Sign Up New User</button>
      <div id="signupResult"></div>
    </div>

    <div class="test-section">
      <h3>Login</h3>
      <input type="email" id="loginEmail" placeholder="Email" value="test@example.com">
      <input type="password" id="loginPassword" placeholder="Password" value="password123">
      <button onclick="testLogin()">Login</button>
      <div id="loginResult"></div>
    </div>

    <div class="test-section">
      <h3>Session Management</h3>
      <button onclick="checkSession()">Check Session</button>
      <button onclick="testLogout()">Logout</button>
      <div id="sessionResult"></div>
    </div>
  </div>

  <!-- Profile Operations -->
  <div class="container">
    <h2>2. Profile Operations</h2>

    <div class="test-section">
      <h3>GET /api/coach-profiles/me</h3>
      <p>Fetch current user's profile (requires authentication)</p>
      <button onclick="testGetMyProfile()">Get My Profile</button>
      <div id="getMyProfileResult"></div>
    </div>

    <div class="test-section">
      <h3>POST /api/coach-profiles</h3>
      <p>Create a new profile (requires authentication)</p>
      <input type="text" id="firstName" placeholder="First Name" value="Test">
      <input type="text" id="lastName" placeholder="Last Name" value="Coach">
      <input type="email" id="profileEmail" placeholder="Email" value="test@example.com">
      <input type="text" id="title" placeholder="Title (optional)" value="Tennis Coach">
      <textarea id="bio" placeholder="Bio (optional)" rows="3">Experienced tennis coach with 10 years of coaching experience.</textarea>
      <button onclick="testCreateProfile()">Create Profile</button>
      <div id="createProfileResult"></div>
    </div>

    <div class="test-section">
      <h3>PUT /api/coach-profiles/me</h3>
      <p>Update current user's profile (requires authentication)</p>
      <input type="text" id="updateTitle" placeholder="New Title" value="Senior Tennis Coach">
      <textarea id="updateBio" placeholder="New Bio" rows="3">Updated bio with more experience.</textarea>
      <button onclick="testUpdateProfile()">Update Profile</button>
      <div id="updateProfileResult"></div>
    </div>

    <div class="test-section">
      <h3>GET /api/coach-profiles/check/:userId</h3>
      <p>Fetch any profile by user ID (public endpoint)</p>
      <input type="text" id="checkUserId" placeholder="User ID">
      <button onclick="testCheckProfile()">Check Profile</button>
      <div id="checkProfileResult"></div>
    </div>
  </div>

  <!-- RLS Security Tests -->
  <div class="container">
    <h2>3. Row Level Security Tests</h2>

    <div class="test-section">
      <h3>Test Unauthorized Access</h3>
      <p>These tests should fail with proper error messages:</p>
      <button onclick="testGetProfileWithoutAuth()">GET without auth</button>
      <button onclick="testCreateProfileWithoutAuth()">POST without auth</button>
      <button onclick="testUpdateProfileWithoutAuth()">PUT without auth</button>
      <div id="rlsTestResult"></div>
    </div>
  </div>

  <!-- All Tests Runner -->
  <div class="container">
    <h2>4. Run All Tests</h2>
    <button onclick="runAllTests()" style="background: #10b981; padding: 12px 24px; font-size: 16px;">
      ‚ñ∂ Run Full Test Suite
    </button>
    <div id="allTestsResult"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://dltscjplwbvtlgguwsbb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsdHNjanBsd2J2dGxnZ3V3c2JiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MjU0NzgsImV4cCI6MjA3NTAwMTQ3OH0.-d2tfOD7N5QgWhJOSpPsti4nF2vp2Nx_4IkZMVsfGKY';
    const API_URL = 'http://localhost:8787';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let currentUser = null;
    let currentToken = null;

    // Initialize
    (async () => {
      const { data } = await supabase.auth.getSession();
      if (data.session) {
        currentUser = data.session.user;
        currentToken = data.session.access_token;
        updateAuthStatus(true);
      }
    })();

    function updateAuthStatus(isAuthenticated) {
      const statusEl = document.getElementById('authStatus');
      if (isAuthenticated && currentUser) {
        statusEl.className = 'auth-status logged-in';
        statusEl.textContent = `‚úÖ Authenticated as ${currentUser.email} (ID: ${currentUser.id})`;
      } else {
        statusEl.className = 'auth-status logged-out';
        statusEl.textContent = '‚ùå Not authenticated';
      }
    }

    function showResult(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      el.className = type;
      el.textContent = message;
    }

    function showJsonResult(elementId, data) {
      const el = document.getElementById(elementId);
      el.className = 'result';
      el.textContent = JSON.stringify(data, null, 2);
    }

    async function testSignup() {
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;

      try {
        const { data, error } = await supabase.auth.signUp({ email, password });

        if (error) throw error;

        currentUser = data.user;
        currentToken = data.session?.access_token;
        updateAuthStatus(true);
        showResult('signupResult', '‚úÖ Sign up successful!', 'success');
        showJsonResult('signupResult', data);
      } catch (error) {
        showResult('signupResult', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function testLogin() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });

        if (error) throw error;

        currentUser = data.user;
        currentToken = data.session.access_token;
        updateAuthStatus(true);
        showResult('loginResult', '‚úÖ Login successful!', 'success');
        showJsonResult('loginResult', data);
      } catch (error) {
        showResult('loginResult', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function checkSession() {
      const { data } = await supabase.auth.getSession();
      showJsonResult('sessionResult', data);
    }

    async function testLogout() {
      await supabase.auth.signOut();
      currentUser = null;
      currentToken = null;
      updateAuthStatus(false);
      showResult('sessionResult', '‚úÖ Logged out successfully', 'success');
    }

    async function testGetMyProfile() {
      if (!currentToken) {
        showResult('getMyProfileResult', '‚ùå Please login first', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/coach-profiles/me`, {
          headers: {
            'Authorization': `Bearer ${currentToken}`,
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (!response.ok) {
          showResult('getMyProfileResult', `‚ùå Error: ${data.error}`, 'error');
        } else {
          showResult('getMyProfileResult', '‚úÖ Profile fetched successfully!', 'success');
        }
        showJsonResult('getMyProfileResult', data);
      } catch (error) {
        showResult('getMyProfileResult', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function testCreateProfile() {
      if (!currentToken) {
        showResult('createProfileResult', '‚ùå Please login first', 'error');
        return;
      }

      const profileData = {
        email: document.getElementById('profileEmail').value,
        first_name: document.getElementById('firstName').value,
        last_name: document.getElementById('lastName').value,
        title: document.getElementById('title').value,
        bio: document.getElementById('bio').value
      };

      try {
        const response = await fetch(`${API_URL}/api/coach-profiles`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${currentToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(profileData)
        });

        const data = await response.json();

        if (!response.ok) {
          showResult('createProfileResult', `‚ùå Error: ${data.error}`, 'error');
        } else {
          showResult('createProfileResult', '‚úÖ Profile created successfully!', 'success');
        }
        showJsonResult('createProfileResult', data);
      } catch (error) {
        showResult('createProfileResult', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function testUpdateProfile() {
      if (!currentToken) {
        showResult('updateProfileResult', '‚ùå Please login first', 'error');
        return;
      }

      const updates = {
        title: document.getElementById('updateTitle').value,
        bio: document.getElementById('updateBio').value
      };

      try {
        const response = await fetch(`${API_URL}/api/coach-profiles/me`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${currentToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updates)
        });

        const data = await response.json();

        if (!response.ok) {
          showResult('updateProfileResult', `‚ùå Error: ${data.error}`, 'error');
        } else {
          showResult('updateProfileResult', '‚úÖ Profile updated successfully!', 'success');
        }
        showJsonResult('updateProfileResult', data);
      } catch (error) {
        showResult('updateProfileResult', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function testCheckProfile() {
      const userId = document.getElementById('checkUserId').value || currentUser?.id;

      if (!userId) {
        showResult('checkProfileResult', '‚ùå Please provide a user ID or login', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/coach-profiles/check/${userId}`);
        const data = await response.json();

        if (!response.ok) {
          showResult('checkProfileResult', `‚ùå Error: ${data.error}`, 'error');
        } else {
          showResult('checkProfileResult', '‚úÖ Profile check successful!', 'success');
        }
        showJsonResult('checkProfileResult', data);
      } catch (error) {
        showResult('checkProfileResult', `‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function testGetProfileWithoutAuth() {
      try {
        const response = await fetch(`${API_URL}/api/coach-profiles/me`);
        const data = await response.json();

        if (!response.ok && response.status === 401) {
          showResult('rlsTestResult', '‚úÖ Correctly blocked: Unauthorized', 'success');
        } else {
          showResult('rlsTestResult', '‚ùå SECURITY ISSUE: Should have been blocked!', 'error');
        }
        showJsonResult('rlsTestResult', data);
      } catch (error) {
        showResult('rlsTestResult', `‚úÖ Correctly blocked: ${error.message}`, 'success');
      }
    }

    async function testCreateProfileWithoutAuth() {
      try {
        const response = await fetch(`${API_URL}/api/coach-profiles`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: 'test@test.com',
            first_name: 'Test',
            last_name: 'User'
          })
        });

        const data = await response.json();

        if (!response.ok && response.status === 401) {
          showResult('rlsTestResult', '‚úÖ Correctly blocked: Unauthorized', 'success');
        } else {
          showResult('rlsTestResult', '‚ùå SECURITY ISSUE: Should have been blocked!', 'error');
        }
        showJsonResult('rlsTestResult', data);
      } catch (error) {
        showResult('rlsTestResult', `‚úÖ Correctly blocked: ${error.message}`, 'success');
      }
    }

    async function testUpdateProfileWithoutAuth() {
      try {
        const response = await fetch(`${API_URL}/api/coach-profiles/me`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title: 'Hacker' })
        });

        const data = await response.json();

        if (!response.ok && response.status === 401) {
          showResult('rlsTestResult', '‚úÖ Correctly blocked: Unauthorized', 'success');
        } else {
          showResult('rlsTestResult', '‚ùå SECURITY ISSUE: Should have been blocked!', 'error');
        }
        showJsonResult('rlsTestResult', data);
      } catch (error) {
        showResult('rlsTestResult', `‚úÖ Correctly blocked: ${error.message}`, 'success');
      }
    }

    async function runAllTests() {
      const resultEl = document.getElementById('allTestsResult');
      resultEl.innerHTML = '<div class="info">‚è≥ Running all tests...</div>';

      const tests = [];
      let passed = 0;
      let failed = 0;

      // Test 1: Session check
      tests.push({ name: 'Session Check', fn: async () => {
        const { data } = await supabase.auth.getSession();
        return data.session ? 'PASS' : 'FAIL';
      }});

      // Test 2-5: Profile operations (if authenticated)
      if (currentToken) {
        tests.push({ name: 'GET My Profile', fn: async () => {
          const response = await fetch(`${API_URL}/api/coach-profiles/me`, {
            headers: { 'Authorization': `Bearer ${currentToken}` }
          });
          return response.ok ? 'PASS' : 'FAIL';
        }});

        tests.push({ name: 'Check Profile by ID', fn: async () => {
          const response = await fetch(`${API_URL}/api/coach-profiles/check/${currentUser.id}`);
          return response.ok ? 'PASS' : 'FAIL';
        }});
      }

      // Test 6-8: RLS security tests
      tests.push({ name: 'Block unauthenticated GET', fn: async () => {
        const response = await fetch(`${API_URL}/api/coach-profiles/me`);
        return response.status === 401 ? 'PASS' : 'FAIL';
      }});

      tests.push({ name: 'Block unauthenticated POST', fn: async () => {
        const response = await fetch(`${API_URL}/api/coach-profiles`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: 'test@test.com', first_name: 'Test', last_name: 'User' })
        });
        return response.status === 401 ? 'PASS' : 'FAIL';
      }});

      // Run tests
      let output = '<div class="result">';
      for (const test of tests) {
        try {
          const result = await test.fn();
          if (result === 'PASS') {
            passed++;
            output += `‚úÖ ${test.name}: PASSED\n`;
          } else {
            failed++;
            output += `‚ùå ${test.name}: FAILED\n`;
          }
        } catch (error) {
          failed++;
          output += `‚ùå ${test.name}: ERROR - ${error.message}\n`;
        }
      }
      output += `\n---\nTotal: ${tests.length} | Passed: ${passed} | Failed: ${failed}\n`;
      output += '</div>';

      if (failed === 0) {
        output = '<div class="success">üéâ All tests passed!</div>' + output;
      } else {
        output = '<div class="error">‚ö†Ô∏è Some tests failed</div>' + output;
      }

      resultEl.innerHTML = output;
    }
  </script>
</body>
</html>
